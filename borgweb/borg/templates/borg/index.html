{% extends "borg/base.html" %}
{% load cache %}
{% load static %}

{% block title %}Borg Summary{% endblock %}
{% block script %}
    {{block.super}}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    {{ hour_list|json_script:"hour_list" }}
    <script src="{% static 'js/index.js' %}"></script>
{% endblock %}

{% block style %}
    {{ block.super }}
    .repo-container {
        padding: 8px;
        margin: 8px;
    }

    .att-label {
        margin-top: 4px;
        margin-bottom: 4px;
    }
{% endblock %}

{% block body %}
{% cache 60 repos %}
{% if repo_list %}
<div class="grid mx-auto d-flex justify-content-center flex-wrap">
    {% for repo in repo_list %}
    <div style="width: 600px;" class="repo-container shadow rounded overflow-hidden
                {% if repo.error %}bg-danger{% elif repo.warning %}bg-warning{% else %}bg-primary{% endif %}">
        <div class="row me-1 overflow-hidden text-truncate">
            <h2 class="h2">{{ repo.label }}
                <small class="text-muted"> {{ repo.location }}</small>
            </h2>
        </div>
        <dl class="att-label row ps-3">
            <dt class="col-4">Latest backup:</dt>
            <dd class="col-8">{{ repo.last_backup }}</dd>
        </dl>
        <dl class="att-label row ps-3">
            <dt class="col-4">Hourly backups:</dt>
            <dd class="col-8 text-truncate">{{ repo.hourly_archive_string }}</dd>
        </dl>
        <dl class="att-label row ps-3">
            <dt class="col-4">Size:</dt>
            <dd class="col-8">{{ repo.size_string }}</dd>
        </dl>
        {% if repo.recent_errors|length > 0 %}
        <dl class="att-label row">
            <dt class="col-12 h4">Recent errors:</dt>
        </dl>
        {% endif %}
        <dl class="att-label row ps-3">
            {% for error in repo.recent_errors %}
            <dt class="col-4">{{ error.time_ago }}</dt>
            <dd class="col-8 text-truncate">{{ error.error }}</dd>
            {% endfor %}
        </dl>
    </div>
    {% endfor %}
    <div style="width: 600px;" class="repo-container shadow rounded bg-primary overflow-hidden">
        <canvas id="backup_csize_hourly" width="400" height="200"></canvas>
    </div>
    {% else %}
    <div style="width: 600px;" class="repo-container shadow rounded bg-primary overflow-hidden">
        <div style="width: 600px;" class="repo-container shadow rounded bg-primary overflow-hidden">
        <h2 class="h2">No repositories found</h2>
    </div>
    </div>
    {% endif %}
    <div style="width: 600px;" class="repo-container shadow rounded bg-primary overflow-hidden">
        <h2 class="h2">Paths</h2>
    {% if location_list %}
        {% for location in location_list %}
        <dl class="att-label row ps-3">
            <dt class="col-3">{{ location.label }}</dt>
            <dd class="col-9">{{ location.short_description }}</dd>
        </dl>
        {% endfor %}
    {% else %}
        <h3 class="h3">None found</h3>
    {% endif %}
    </div>
</div>
{% endcache %}
{% endblock %}

